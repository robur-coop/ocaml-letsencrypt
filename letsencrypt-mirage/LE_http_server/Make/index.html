<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Make (letsencrypt-mirage.LE_http_server.Make)</title><link rel="stylesheet" href="../../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 2.2.0"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">letsencrypt-mirage</a> &#x00BB; <a href="../index.html">LE_http_server</a> &#x00BB; Make</nav><header class="odoc-preamble"><h1>Module <code><span>LE_http_server.Make</span></code></h1></header><nav class="odoc-toc"><ul><li><a href="#parameters">Parameters</a></li><li><a href="#signature">Signature</a></li></ul></nav><div class="odoc-content"><h2 id="parameters"><a href="#parameters" class="anchor"></a>Parameters</h2><div class="odoc-spec"><div class="spec parameter anchored" id="argument-1-Time"><a href="#argument-1-Time" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Time</span><span> : <span class="xref-unresolved">Mirage_time</span>.S</span></code></div></div><div class="odoc-spec"><div class="spec parameter anchored" id="argument-2-Stack"><a href="#argument-2-Stack" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Stack</span><span> : <span class="xref-unresolved">Tcpip</span>.Stack.V4V6</span></code></div></div><div class="odoc-spec"><div class="spec parameter anchored" id="argument-3-Random"><a href="#argument-3-Random" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Random</span><span> : <span class="xref-unresolved">Mirage_random</span>.S</span></code></div></div><div class="odoc-spec"><div class="spec parameter anchored" id="argument-4-Mclock"><a href="#argument-4-Mclock" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Mclock</span><span> : <span class="xref-unresolved">Mirage_clock</span>.MCLOCK</span></code></div></div><div class="odoc-spec"><div class="spec parameter anchored" id="argument-5-Pclock"><a href="#argument-5-Pclock" class="anchor"></a><code><span><span class="keyword">module</span> </span><span>Pclock</span><span> : <span class="xref-unresolved">Mirage_clock</span>.PCLOCK</span></code></div></div><h2 id="signature"><a href="#signature" class="anchor"></a>Signature</h2><div class="odoc-spec"><div class="spec value anchored" id="val-get_certificates"><a href="#val-get_certificates" class="anchor"></a><code><span><span class="keyword">val</span> get_certificates : 
  <span>yes_my_port_80_is_reachable_and_unused:<span class="xref-unresolved">Stack</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>production:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../LE/index.html#type-configuration">LE.configuration</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Http_mirage_client</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<span class="xref-unresolved">Tls</span>.Config.own_cert, <span>[&gt; <span>`Msg of string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>get_certificates ~yes_my_port_80_is_reachable_and_unused ~production cfg client</code> tries to resolve the Let's encrypt challenge by initiating an HTTP server on port 80 and handling requests from it with <code>ocaml-letsencrypt</code>.</p><p>This resolution requires that your domain name (requested in the given <code>cfg.hostname</code>) redirects Let's encrypt to this HTTP server. You probably need to check your DNS configuration.</p><p>The <code>client</code> value can be made by <code>Http_mirage_client</code>.Make.connect to be able to launch HTTP requests to Let's encrypt.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Paf"><a href="#module-Paf" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Paf/index.html">Paf</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_lets_encrypt_certificates"><a href="#val-with_lets_encrypt_certificates" class="anchor"></a><code><span><span class="keyword">val</span> with_lets_encrypt_certificates : 
  <span>?port:int <span class="arrow">&#45;&gt;</span></span>
  <span>?alpn_protocols:<span>string list</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Stack</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span>production:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../LE/index.html#type-configuration">LE.configuration</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="xref-unresolved">Http_mirage_client</span>.t <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(<a href="Paf/TLS/index.html#type-flow">Paf.TLS.flow</a>, <span class="xref-unresolved">Ipaddr</span>.t * int)</span> <span class="xref-unresolved">Alpn</span>.server_handler</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span>(unit, <span>[&gt; <span>`Msg of string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span> <span class="xref-unresolved">Lwt</span>.t</span></span></code></div><div class="spec-doc"><p><code>with_lets_encrypt_certificates ?port ?alpn_protocols stackv4v6 ~production cfg client handler</code> launches 2 servers:</p><ul><li>An HTTP/1.1 server which handles let's encrypt challenges and redirections</li><li>An ALPN server (which handles HTTP/1.1 and H2 by default, otherwise you can specify protocols via the <code>alpn_protocol</code> argument) which run the user's request handler</li></ul><p>The <code>client</code> value can be made by <code>Http_mirage_client</code>.Make.connect to be able to launch HTTP requests to Let's encrypt.</p><p>Every 80 days, the fiber re-askes a new certificate from let's encrypt and re-update the ALPN server with this new certificate. The HTTP/1.1 server does the redirection to the hostname defined into the given <code>cfg</code>.</p><p><b>NOTE</b>: For the <code>alpn_protocols</code> argument, only <code>&quot;h2&quot;</code>, <code>&quot;http/1.1&quot;</code> and <code>&quot;http/1.0&quot;</code> are handled. Any others protocols will be <b>ignored</b>! The order of protocols matters. If <code>&quot;h2&quot;</code> is the first one and the client handles the <code>&quot;h2&quot;</code> protocol, server and client agree to use this protocol (even if both handle <code>&quot;http/1.1&quot;</code>).</p><p>The default value of <code>alpn_protocols</code> prioritises <code>&quot;http/1.1&quot;</code> as the protocol which should be picked by the client.</p></div></div></div></body></html>